/* 5. 전년도 대비 및 월별 대비 환불 비중 비교 - SQL */
WITH WT_WHERE AS
    (
        SELECT {BASE_YEAR}  AS BASE_YEAR  /* 사용자가 선택한 년도  ※ 최초 셋팅값 : 이번년도 ex) '2023'  */
    ), WT_COPY AS
    (
        SELECT 1            AS SORT_KEY
              ,'환불 금액'  AS ROW_TITL
     UNION ALL
        SELECT 2            AS SORT_KEY
              ,'환불 비중'  AS ROW_TITL
     UNION ALL
        SELECT 3            AS SORT_KEY
              ,'YoY (전년도 동월 대비 환불 증감)'    AS ROW_TITL
     UNION ALL
        SELECT 4            AS SORT_KEY
              ,'MoM (당해 연도 전월 대비 환불 증감)' AS ROW_TITL
    ), WT_COPY_MNTH AS
    (
        SELECT '01'        AS COL_MNTH
     UNION ALL
        SELECT '02'        AS COL_MNTH
     UNION ALL
        SELECT '03'        AS COL_MNTH
     UNION ALL
        SELECT '04'        AS COL_MNTH
     UNION ALL
        SELECT '05'        AS COL_MNTH
     UNION ALL
        SELECT '06'        AS COL_MNTH
     UNION ALL
        SELECT '07'        AS COL_MNTH
     UNION ALL
        SELECT '08'        AS COL_MNTH
     UNION ALL
        SELECT '09'        AS COL_MNTH
     UNION ALL
        SELECT '10'        AS COL_MNTH
     UNION ALL
        SELECT '11'        AS COL_MNTH
     UNION ALL
        SELECT '12'        AS COL_MNTH
    ), WT_EXCH AS
    (
        SELECT TO_CHAR(CAST(STATISTICS_DATE AS DATE), 'MM') AS COL_MNTH
              ,PAYMENT_AMOUNT                                                     AS SALE_AMT_RMB   /* 일매출 - 위안화 */
              ,SUCCESSFUL_REFUND_AMOUNT                                           AS REFD_AMT_RMB   /* 일환불 - 위안화 */
              ,PAYMENT_AMOUNT           * DASH_RAW.SF_EXCH_KRW(A.STATISTICS_DATE) AS SALE_AMT_KRW   /* 일매출 - 원화   */
              ,SUCCESSFUL_REFUND_AMOUNT * DASH_RAW.SF_EXCH_KRW(A.STATISTICS_DATE) AS REFD_AMT_KRW   /* 일환불 - 원화   */
          FROM DASH_RAW.OVER_{TAG}_OVERALL_STORE A
         WHERE STATISTICS_DATE LIKE CONCAT((SELECT BASE_YEAR FROM WT_WHERE), '%')
     UNION ALL
        SELECT '00' AS COL_MNTH
              ,PAYMENT_AMOUNT                                                     AS SALE_AMT_RMB   /* 일매출 - 위안화 */
              ,SUCCESSFUL_REFUND_AMOUNT                                           AS REFD_AMT_RMB   /* 일환불 - 위안화 */
              ,PAYMENT_AMOUNT           * DASH_RAW.SF_EXCH_KRW(A.STATISTICS_DATE) AS SALE_AMT_KRW   /* 일매출 - 원화   */
              ,SUCCESSFUL_REFUND_AMOUNT * DASH_RAW.SF_EXCH_KRW(A.STATISTICS_DATE) AS REFD_AMT_KRW   /* 일환불 - 원화   */
          FROM DASH_RAW.OVER_{TAG}_OVERALL_STORE A
         WHERE STATISTICS_DATE LIKE CONCAT((SELECT CAST(CAST(BASE_YEAR AS INTEGER) - 1 AS TEXT) FROM WT_WHERE), '-12%')
    ), WT_EXCH_YOY AS
    (
        SELECT TO_CHAR(CAST(STATISTICS_DATE AS DATE), 'MM') AS COL_MNTH
              ,PAYMENT_AMOUNT                                                     AS SALE_AMT_RMB   /* 일매출 - 위안화 */
              ,SUCCESSFUL_REFUND_AMOUNT                                           AS REFD_AMT_RMB   /* 일환불 - 위안화 */
              ,PAYMENT_AMOUNT           * DASH_RAW.SF_EXCH_KRW(A.STATISTICS_DATE) AS SALE_AMT_KRW   /* 일매출 - 원화   */
              ,SUCCESSFUL_REFUND_AMOUNT * DASH_RAW.SF_EXCH_KRW(A.STATISTICS_DATE) AS REFD_AMT_KRW   /* 일환불 - 원화   */
          FROM DASH_RAW.OVER_{TAG}_OVERALL_STORE A
         WHERE STATISTICS_DATE LIKE CONCAT((SELECT CAST(CAST(BASE_YEAR AS integer) - 1 AS TEXT) FROM WT_WHERE), '%')
    ), WT_AMT AS
    (
        SELECT COL_MNTH
              ,SUM(REFD_AMT_RMB) AS REFD_RMB  /* 환불금액 - 위안화 */
              ,SUM(REFD_AMT_KRW) AS REFD_KRW  /* 환불금액 - 원화   */
          FROM WT_EXCH A
      GROUP BY COL_MNTH
    ), WT_RATE AS
    (
        SELECT COL_MNTH
              ,SUM(REFD_AMT_RMB) / COALESCE(NULLIF(SUM(SALE_AMT_RMB), 0), 1) * 100 AS REFD_RMB  /* 환불비중 - 위안화 */
              ,SUM(REFD_AMT_KRW) / COALESCE(NULLIF(SUM(SALE_AMT_KRW), 0), 1) * 100 AS REFD_KRW  /* 환불비중 - 원화   */
          FROM WT_EXCH A
      GROUP BY COL_MNTH
    ), WT_RATE_YOY AS
    (
        SELECT COL_MNTH
              ,SUM(REFD_AMT_RMB) / COALESCE(NULLIF(SUM(SALE_AMT_RMB), 0), 1) * 100 AS REFD_RMB  /* 환불비중 - 위안화 */
              ,SUM(REFD_AMT_KRW) / COALESCE(NULLIF(SUM(SALE_AMT_KRW), 0), 1) * 100 AS REFD_KRW  /* 환불비중 - 원화   */
          FROM WT_EXCH_YOY A
      GROUP BY COL_MNTH
    ), WT_ALL AS
    (
        SELECT 1 AS SORT_KEY
              ,COL_MNTH
              ,REFD_RMB
              ,REFD_KRW
          FROM WT_AMT
     UNION ALL
        SELECT 2 AS SORT_KEY
              ,COL_MNTH
              ,REFD_RMB
              ,REFD_KRW
          FROM WT_RATE
     UNION ALL
        SELECT 3 AS SORT_KEY
              ,A.COL_MNTH
              ,CAST(B.REFD_RMB AS DECIMAL(20,2)) - CAST(C.REFD_RMB AS DECIMAL(20,2)) AS REFD_RMB
              ,CAST(B.REFD_KRW AS DECIMAL(20,2)) - CAST(C.REFD_KRW AS DECIMAL(20,2)) AS REFD_KRW
          FROM WT_COPY_MNTH A LEFT OUTER JOIN WT_RATE     B ON (A.COL_MNTH = B.COL_MNTH)
                              LEFT OUTER JOIN WT_RATE_YOY C ON (A.COL_MNTH = C.COL_MNTH)
     UNION ALL
        SELECT 4 AS SORT_KEY
              ,A.COL_MNTH
              ,CAST(A.REFD_RMB AS DECIMAL(20,2)) - CAST(B.REFD_RMB AS DECIMAL(20,2)) AS REFD_RMB
              ,CAST(A.REFD_KRW AS DECIMAL(20,2)) - CAST(B.REFD_KRW AS DECIMAL(20,2)) AS REFD_KRW
          FROM WT_RATE A INNER JOIN WT_RATE B
            ON(CAST(A.COL_MNTH AS INT) = CAST(B.COL_MNTH AS INT) + 1)
    ), WT_BASE AS
    (
        SELECT A.SORT_KEY
              ,A.ROW_TITL
              ,CAST(MAX(CASE WHEN B.COL_MNTH = '01' THEN B.REFD_RMB END) AS DECIMAL(20,2)) AS REFD_01_RMB /* 01월 - 위안화 */
              ,CAST(MAX(CASE WHEN B.COL_MNTH = '02' THEN B.REFD_RMB END) AS DECIMAL(20,2)) AS REFD_02_RMB /* 02월 - 위안화 */
              ,CAST(MAX(CASE WHEN B.COL_MNTH = '03' THEN B.REFD_RMB END) AS DECIMAL(20,2)) AS REFD_03_RMB /* 03월 - 위안화 */
              ,CAST(MAX(CASE WHEN B.COL_MNTH = '04' THEN B.REFD_RMB END) AS DECIMAL(20,2)) AS REFD_04_RMB /* 04월 - 위안화 */
              ,CAST(MAX(CASE WHEN B.COL_MNTH = '05' THEN B.REFD_RMB END) AS DECIMAL(20,2)) AS REFD_05_RMB /* 05월 - 위안화 */
              ,CAST(MAX(CASE WHEN B.COL_MNTH = '06' THEN B.REFD_RMB END) AS DECIMAL(20,2)) AS REFD_06_RMB /* 06월 - 위안화 */
              ,CAST(MAX(CASE WHEN B.COL_MNTH = '07' THEN B.REFD_RMB END) AS DECIMAL(20,2)) AS REFD_07_RMB /* 07월 - 위안화 */
              ,CAST(MAX(CASE WHEN B.COL_MNTH = '08' THEN B.REFD_RMB END) AS DECIMAL(20,2)) AS REFD_08_RMB /* 08월 - 위안화 */
              ,CAST(MAX(CASE WHEN B.COL_MNTH = '09' THEN B.REFD_RMB END) AS DECIMAL(20,2)) AS REFD_09_RMB /* 09월 - 위안화 */
              ,CAST(MAX(CASE WHEN B.COL_MNTH = '10' THEN B.REFD_RMB END) AS DECIMAL(20,2)) AS REFD_10_RMB /* 10월 - 위안화 */
              ,CAST(MAX(CASE WHEN B.COL_MNTH = '11' THEN B.REFD_RMB END) AS DECIMAL(20,2)) AS REFD_11_RMB /* 11월 - 위안화 */
              ,CAST(MAX(CASE WHEN B.COL_MNTH = '12' THEN B.REFD_RMB END) AS DECIMAL(20,2)) AS REFD_12_RMB /* 12월 - 위안화 */
    
              ,CAST(MAX(CASE WHEN B.COL_MNTH = '01' THEN B.REFD_KRW END) AS DECIMAL(20,2)) AS REFD_01_KRW /* 01월 - 원화   */
              ,CAST(MAX(CASE WHEN B.COL_MNTH = '02' THEN B.REFD_KRW END) AS DECIMAL(20,2)) AS REFD_02_KRW /* 02월 - 원화   */
              ,CAST(MAX(CASE WHEN B.COL_MNTH = '03' THEN B.REFD_KRW END) AS DECIMAL(20,2)) AS REFD_03_KRW /* 03월 - 원화   */
              ,CAST(MAX(CASE WHEN B.COL_MNTH = '04' THEN B.REFD_KRW END) AS DECIMAL(20,2)) AS REFD_04_KRW /* 04월 - 원화   */
              ,CAST(MAX(CASE WHEN B.COL_MNTH = '05' THEN B.REFD_KRW END) AS DECIMAL(20,2)) AS REFD_05_KRW /* 05월 - 원화   */
              ,CAST(MAX(CASE WHEN B.COL_MNTH = '06' THEN B.REFD_KRW END) AS DECIMAL(20,2)) AS REFD_06_KRW /* 06월 - 원화   */
              ,CAST(MAX(CASE WHEN B.COL_MNTH = '07' THEN B.REFD_KRW END) AS DECIMAL(20,2)) AS REFD_07_KRW /* 07월 - 원화   */
              ,CAST(MAX(CASE WHEN B.COL_MNTH = '08' THEN B.REFD_KRW END) AS DECIMAL(20,2)) AS REFD_08_KRW /* 08월 - 원화   */
              ,CAST(MAX(CASE WHEN B.COL_MNTH = '09' THEN B.REFD_KRW END) AS DECIMAL(20,2)) AS REFD_09_KRW /* 09월 - 원화   */
              ,CAST(MAX(CASE WHEN B.COL_MNTH = '10' THEN B.REFD_KRW END) AS DECIMAL(20,2)) AS REFD_10_KRW /* 10월 - 원화   */
              ,CAST(MAX(CASE WHEN B.COL_MNTH = '11' THEN B.REFD_KRW END) AS DECIMAL(20,2)) AS REFD_11_KRW /* 11월 - 원화   */
              ,CAST(MAX(CASE WHEN B.COL_MNTH = '12' THEN B.REFD_KRW END) AS DECIMAL(20,2)) AS REFD_12_KRW /* 12월 - 원화   */
          FROM WT_COPY A LEFT OUTER JOIN WT_ALL B ON (A.SORT_KEY = B.SORT_KEY)
      GROUP BY A.SORT_KEY
              ,A.ROW_TITL
    )
    SELECT SORT_KEY
          ,ROW_TITL
          ,CASE WHEN SORT_KEY = 1 THEN TO_CHAR(REFD_01_RMB, 'FM999,999,999,999,990') ELSE TO_CHAR(REFD_01_RMB, 'FM999,999,999,999,990.00%') END AS REFD_01_RMB /* 01월 - 위안화 */
          ,CASE WHEN SORT_KEY = 1 THEN TO_CHAR(REFD_02_RMB, 'FM999,999,999,999,990') ELSE TO_CHAR(REFD_02_RMB, 'FM999,999,999,999,990.00%') END AS REFD_02_RMB /* 02월 - 위안화 */
          ,CASE WHEN SORT_KEY = 1 THEN TO_CHAR(REFD_03_RMB, 'FM999,999,999,999,990') ELSE TO_CHAR(REFD_03_RMB, 'FM999,999,999,999,990.00%') END AS REFD_03_RMB /* 03월 - 위안화 */
          ,CASE WHEN SORT_KEY = 1 THEN TO_CHAR(REFD_04_RMB, 'FM999,999,999,999,990') ELSE TO_CHAR(REFD_04_RMB, 'FM999,999,999,999,990.00%') END AS REFD_04_RMB /* 04월 - 위안화 */
          ,CASE WHEN SORT_KEY = 1 THEN TO_CHAR(REFD_05_RMB, 'FM999,999,999,999,990') ELSE TO_CHAR(REFD_05_RMB, 'FM999,999,999,999,990.00%') END AS REFD_05_RMB /* 05월 - 위안화 */
          ,CASE WHEN SORT_KEY = 1 THEN TO_CHAR(REFD_06_RMB, 'FM999,999,999,999,990') ELSE TO_CHAR(REFD_06_RMB, 'FM999,999,999,999,990.00%') END AS REFD_06_RMB /* 06월 - 위안화 */
          ,CASE WHEN SORT_KEY = 1 THEN TO_CHAR(REFD_07_RMB, 'FM999,999,999,999,990') ELSE TO_CHAR(REFD_07_RMB, 'FM999,999,999,999,990.00%') END AS REFD_07_RMB /* 07월 - 위안화 */
          ,CASE WHEN SORT_KEY = 1 THEN TO_CHAR(REFD_08_RMB, 'FM999,999,999,999,990') ELSE TO_CHAR(REFD_08_RMB, 'FM999,999,999,999,990.00%') END AS REFD_08_RMB /* 08월 - 위안화 */
          ,CASE WHEN SORT_KEY = 1 THEN TO_CHAR(REFD_09_RMB, 'FM999,999,999,999,990') ELSE TO_CHAR(REFD_09_RMB, 'FM999,999,999,999,990.00%') END AS REFD_09_RMB /* 09월 - 위안화 */
          ,CASE WHEN SORT_KEY = 1 THEN TO_CHAR(REFD_10_RMB, 'FM999,999,999,999,990') ELSE TO_CHAR(REFD_10_RMB, 'FM999,999,999,999,990.00%') END AS REFD_10_RMB /* 10월 - 위안화 */
          ,CASE WHEN SORT_KEY = 1 THEN TO_CHAR(REFD_11_RMB, 'FM999,999,999,999,990') ELSE TO_CHAR(REFD_11_RMB, 'FM999,999,999,999,990.00%') END AS REFD_11_RMB /* 11월 - 위안화 */
          ,CASE WHEN SORT_KEY = 1 THEN TO_CHAR(REFD_12_RMB, 'FM999,999,999,999,990') ELSE TO_CHAR(REFD_12_RMB, 'FM999,999,999,999,990.00%') END AS REFD_12_RMB /* 12월 - 위안화 */

          ,CASE WHEN SORT_KEY = 1 THEN TO_CHAR(REFD_01_KRW, 'FM999,999,999,999,990') ELSE TO_CHAR(REFD_01_KRW, 'FM999,999,999,999,990.00%') END AS REFD_01_KRW /* 01월 - 원화   */
          ,CASE WHEN SORT_KEY = 1 THEN TO_CHAR(REFD_02_KRW, 'FM999,999,999,999,990') ELSE TO_CHAR(REFD_02_KRW, 'FM999,999,999,999,990.00%') END AS REFD_02_KRW /* 02월 - 원화   */
          ,CASE WHEN SORT_KEY = 1 THEN TO_CHAR(REFD_03_KRW, 'FM999,999,999,999,990') ELSE TO_CHAR(REFD_03_KRW, 'FM999,999,999,999,990.00%') END AS REFD_03_KRW /* 03월 - 원화   */
          ,CASE WHEN SORT_KEY = 1 THEN TO_CHAR(REFD_04_KRW, 'FM999,999,999,999,990') ELSE TO_CHAR(REFD_04_KRW, 'FM999,999,999,999,990.00%') END AS REFD_04_KRW /* 04월 - 원화   */
          ,CASE WHEN SORT_KEY = 1 THEN TO_CHAR(REFD_05_KRW, 'FM999,999,999,999,990') ELSE TO_CHAR(REFD_05_KRW, 'FM999,999,999,999,990.00%') END AS REFD_05_KRW /* 05월 - 원화   */
          ,CASE WHEN SORT_KEY = 1 THEN TO_CHAR(REFD_06_KRW, 'FM999,999,999,999,990') ELSE TO_CHAR(REFD_06_KRW, 'FM999,999,999,999,990.00%') END AS REFD_06_KRW /* 06월 - 원화   */
          ,CASE WHEN SORT_KEY = 1 THEN TO_CHAR(REFD_07_KRW, 'FM999,999,999,999,990') ELSE TO_CHAR(REFD_07_KRW, 'FM999,999,999,999,990.00%') END AS REFD_07_KRW /* 07월 - 원화   */
          ,CASE WHEN SORT_KEY = 1 THEN TO_CHAR(REFD_08_KRW, 'FM999,999,999,999,990') ELSE TO_CHAR(REFD_08_KRW, 'FM999,999,999,999,990.00%') END AS REFD_08_KRW /* 08월 - 원화   */
          ,CASE WHEN SORT_KEY = 1 THEN TO_CHAR(REFD_09_KRW, 'FM999,999,999,999,990') ELSE TO_CHAR(REFD_09_KRW, 'FM999,999,999,999,990.00%') END AS REFD_09_KRW /* 09월 - 원화   */
          ,CASE WHEN SORT_KEY = 1 THEN TO_CHAR(REFD_10_KRW, 'FM999,999,999,999,990') ELSE TO_CHAR(REFD_10_KRW, 'FM999,999,999,999,990.00%') END AS REFD_10_KRW /* 10월 - 원화   */
          ,CASE WHEN SORT_KEY = 1 THEN TO_CHAR(REFD_11_KRW, 'FM999,999,999,999,990') ELSE TO_CHAR(REFD_11_KRW, 'FM999,999,999,999,990.00%') END AS REFD_11_KRW /* 11월 - 원화   */
          ,CASE WHEN SORT_KEY = 1 THEN TO_CHAR(REFD_12_KRW, 'FM999,999,999,999,990') ELSE TO_CHAR(REFD_12_KRW, 'FM999,999,999,999,990.00%') END AS REFD_12_KRW /* 12월 - 원화   */
      FROM WT_BASE
  ORDER BY SORT_KEY
